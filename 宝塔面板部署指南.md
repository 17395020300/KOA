# 聊天室系统 - 宝塔面板部署指南

本指南将帮助您在宝塔面板上部署基于KOA2的聊天室系统。

## 一、环境准备

在宝塔面板中，您需要安装以下软件：

1. **Node.js** (v14.0.0 或更高版本)
2. **MySQL** (5.7 或更高版本)
3. **Redis** (可选，如果不需要缓存功能可以不安装)

## 二、项目上传

1. 通过宝塔面板的**文件**功能，创建一个新的网站目录，例如 `/www/wwwroot/chat-system`
2. 使用Git克隆或FTP上传项目代码到该目录

## 三、数据库配置

1. 通过宝塔面板的**数据库**功能，创建一个新的MySQL数据库
   - 数据库名称：推荐使用`newstroge`（与.env文件保持一致）
   - 用户名和密码：自定义并记住
   - 字符集：选择`utf8mb4`，排序规则：`utf8mb4_unicode_ci`

## 四、配置环境变量

1. 在项目根目录创建或修改`.env`文件
2. 根据您的实际配置，填写以下内容：

```env
# 服务器配置
PORT=1998
HOST=0.0.0.0  # 宝塔环境下需要设置为0.0.0.0

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=您的数据库用户名
DB_PASSWORD=您的数据库密码
DB_NAME=newstroge

# Redis配置（如果使用Redis）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=您的Redis密码（如果设置了的话）

# JWT配置
JWT_SECRET=your_jwt_secret_key  # 建议设置一个复杂的密钥
JWT_EXPIRES_IN=24h

# HTTPS配置（如果需要，宝塔面板可以直接配置SSL证书，这里可以不用设置）
# HTTPS_KEY=./ssl/key.pem
# HTTPS_CERT=./ssl/cert.pem

# 短信验证码服务配置（如果需要实际发送验证码，需要配置真实的API密钥）
# SMS_API_KEY=your_sms_api_key
# SMS_API_SECRET=your_sms_api_secret
```

## 五、安装依赖

1. 通过宝塔面板的**终端**功能，进入项目目录
2. 执行以下命令安装依赖：

```bash
npm install
```

## 六、初始化数据库

1. 执行数据库迁移命令，创建表结构：

```bash
npm run migrate
```

> 注意：此命令会创建数据库表并初始化测试数据。生产环境如果需要保留现有数据，请谨慎使用（migrate.js中的force: true会删除已有的表）。

## 七、配置PM2进程管理

1. 通过宝塔面板的**软件商店**安装`PM2管理器`
2. 打开PM2管理器，点击**添加项目**
   - 项目名称：自定义，例如`chat-system`
   - 运行目录：选择您的项目目录，例如`/www/wwwroot/chat-system`
   - 启动文件：`app.js`
   - 启动模式：`cluster`（生产环境推荐）或`fork`
   - 进程数量：根据服务器配置选择，一般为1-4个
3. 点击**确定**添加项目，PM2会自动启动您的应用

## 八、配置Nginx反向代理（可选，但推荐）

如果您需要通过域名访问聊天室系统，或者需要配置SSL证书，可以通过宝塔面板配置Nginx反向代理：

1. 通过宝塔面板的**网站**功能，添加一个新的网站
   - 域名：输入您的域名
   - 根目录：选择您的项目目录下的`public`文件夹，例如`/www/wwwroot/chat-system/public`
2. 点击新创建的网站，进入**设置** -> **反向代理**
3. 点击**添加反向代理**
   - 代理名称：自定义
   - 目标URL：`http://127.0.0.1:1998`（注意端口号要与.env中的PORT保持一致）
   - 点击**保存**
4. 如果需要配置SSL证书，返回网站设置，点击**SSL**，选择**Let's Encrypt**或上传您的证书

## 九、验证部署

1. 打开浏览器，访问您的域名或服务器IP+端口号（例如`http://您的域名`或`http://您的服务器IP:1998`）
2. 如果看到相关页面或API可以访问，则表示部署成功

## 十、常见问题及解决方案

### 1. 数据库连接失败
- 检查.env文件中的数据库配置是否正确
- 确保MySQL服务正在运行
- 确认数据库用户有足够的权限

### 2. 端口被占用
- 修改.env文件中的PORT为未被占用的端口
- 重启PM2服务以应用新的端口配置

### 3. Redis连接失败
- 如果不使用Redis，可以在代码中暂时禁用Redis相关功能
- 检查Redis服务是否正在运行
- 确认Redis配置是否正确

### 4. API访问出现401未授权错误
- 检查JWT_SECRET是否设置正确
- 确保请求中包含有效的token

## 十一、部署后的管理

1. **查看日志**：通过PM2管理器可以查看应用的运行日志
2. **重启应用**：在PM2管理器中可以重启、停止或删除项目
3. **更新代码**：上传新代码后，需要重启PM2项目以应用更新
4. **备份数据**：定期通过宝塔面板的数据库备份功能备份您的数据

## 十二、安全建议

1. 不要在生产环境使用默认的JWT_SECRET
2. 定期修改数据库密码
3. 配置合适的文件权限
4. 使用HTTPS加密传输
5. 定期更新依赖包以修复安全漏洞

祝您部署顺利！如果有其他问题，请参考项目文档或联系技术支持。